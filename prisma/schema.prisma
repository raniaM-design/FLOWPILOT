// Prisma schema for FlowPilot
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Models
model Company {
  id        String   @id @default(cuid())
  name      String
  domain    String? // Domaine email optionnel (ex: "example.com")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     User[]
  invitations CompanyInvitation[]

  @@index([domain])
}

model User {
  id                      String   @id @default(cuid())
  email                   String   @unique
  passwordHash            String? // Optionnel pour les utilisateurs OAuth
  name                    String? // Nom d'affichage (peut être défini par l'admin de l'entreprise)
  avatarUrl               String? // URL de la photo de profil
  role                    String   @default("USER") // "USER" | "ADMIN" | "SUPPORT"
  preferredLanguage       String? // "fr" | "en"
  companyId               String? // Entreprise de l'utilisateur
  isCompanyAdmin          Boolean  @default(false) // Admin de l'entreprise (peut gérer les membres)
  // OAuth
  authProvider            String? // "google" | "password" (null = password legacy)
  providerId              String? // ID unique du provider (ex: Google sub)
  // Préférences d'affichage
  displayReduceAnimations Boolean  @default(false)
  displayMode             String? // "standard" | "simplified"
  displayDensity          String? // "comfort" | "standard" | "compact"
  displayTheme            String? // "light" | "dark" | "system"
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  company                 Company?             @relation(fields: [companyId], references: [id], onDelete: SetNull)
  projects                Project[]
  createdDecisions        Decision[]
  createdActions          ActionItem[]         @relation("CreatedActions")
  assignedActions         ActionItem[]         @relation("AssignedActions")
  meetings                Meeting[]
  outlookAccount          OutlookAccount?
  outlookSyncState        OutlookSyncState?
  passwordResetTokens     PasswordResetToken[]
  notifications           Notification[]
  messages                Message[]
  actionInvitations       ActionInvitation[]   @relation("ActionInvitee")
  actionInvitationsSent   ActionInvitation[]   @relation("ActionInviter")
  decisionInvitations     DecisionInvitation[] @relation("DecisionInvitee")
  decisionInvitationsSent DecisionInvitation[] @relation("DecisionInviter")
  meetingInvitations      MeetingInvitation[]  @relation("MeetingInvitee")
  meetingInvitationsSent  MeetingInvitation[]  @relation("MeetingInviter")
  companyInvitationsSent  CompanyInvitation[]  @relation("CompanyInviter")
  actionMentions          ActionMention[]      @relation("ActionMentions")
  decisionMentions        DecisionMention[]    @relation("DecisionMentions")
  meetingMentions         MeetingMention[]     @relation("MeetingMentions")
  comments                Comment[]            @relation("CommentAuthor")
  onboardingSteps         OnboardingStep[]
  pageViews               PageView[]           @relation("PageViews")

  @@unique([authProvider, providerId]) // Un utilisateur unique par provider+providerId
  @@index([companyId])
  @@index([authProvider, providerId]) // Index pour la recherche OAuth
}

model Project {
  id          String   @id @default(cuid())
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name        String
  description String?
  client      String? // Nom du client
  teamMembers String? // JSON array des membres d'équipe
  status      String   @default("ACTIVE") // ProjectStatus: ACTIVE | PAUSED | DONE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  decisions Decision[]
  actions   ActionItem[]
  meetings  Meeting[]

  @@index([ownerId])
  @@index([status])
}

model Decision {
  id          String   @id @default(cuid())
  projectId   String
  createdById String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  title       String
  context     String?
  decision    String?
  status      String   @default("DRAFT") // DecisionStatus: DRAFT | DECIDED | ARCHIVED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  actions     ActionItem[]
  invitations DecisionInvitation[]
  mentions    DecisionMention[]
  comments    Comment[]            @relation("DecisionComments")

  @@index([projectId])
  @@index([status])
}

model ActionItem {
  id          String    @id @default(cuid())
  projectId   String
  decisionId  String?
  meetingId   String?
  createdById String
  assigneeId  String?
  title       String
  description String?
  status      String    @default("TODO") // ActionStatus: TODO | DOING | DONE | BLOCKED
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project     Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  decision    Decision?          @relation(fields: [decisionId], references: [id], onDelete: SetNull)
  meeting     Meeting?           @relation(fields: [meetingId], references: [id], onDelete: SetNull)
  createdBy   User               @relation("CreatedActions", fields: [createdById], references: [id], onDelete: Cascade)
  assignee    User?              @relation("AssignedActions", fields: [assigneeId], references: [id], onDelete: SetNull)
  invitations ActionInvitation[]
  mentions    ActionMention[]
  comments    Comment[]          @relation("ActionComments")

  @@index([projectId])
  @@index([decisionId])
  @@index([meetingId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
}

model Meeting {
  id                    String    @id @default(cuid())
  ownerId               String
  owner                 User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  projectId             String? // Projet lié à la réunion (optionnel)
  project               Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title                 String
  date                  DateTime
  participants          String?
  context               String? // Lien projet/client optionnel (texte libre)
  raw_notes             String // Texte du compte rendu
  analysisJson          String? // Dernier résultat d'analyse (JSON)
  analyzedAt            DateTime? // Date de dernière analyse
  externalProvider      String? // "outlook"
  externalEventId       String? // id event Outlook (unique par user)
  externalCalendarId    String?
  externalICalUId       String? // iCalUId Outlook (pour détection doublons)
  externalLastModified  DateTime? // lastModifiedDateTime Outlook
  externalIsCancelled   Boolean   @default(false) // isCancelled Outlook
  externalStartDateTime DateTime? // start.dateTime Outlook (normalisé)
  externalEndDateTime   DateTime? // end.dateTime Outlook (normalisé)
  isSynced              Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  actions     ActionItem[]
  invitations MeetingInvitation[]
  mentions    MeetingMention[]

  @@unique([ownerId, externalEventId])
  @@index([ownerId])
  @@index([date])
  @@index([externalICalUId])
  @@index([projectId])
}

model OutlookAccount {
  id                String   @id @default(cuid())
  userId            String   @unique
  provider          String   @default("outlook")
  email             String? // Email Outlook connecté (ex: user@outlook.com)
  providerAccountId String? // ID du compte Microsoft (ex: objectId Azure AD)
  accessToken       String? // Optionnel (peut être null si seul refreshToken stocké)
  refreshToken      String // Obligatoire
  expiresAt         DateTime
  scope             String?
  tokenType         String?
  connectedAt       DateTime @default(now()) // Date de connexion du compte Outlook
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OutlookSyncState {
  id             String    @id @default(cuid())
  userId         String    @unique
  deltaLink      String? // Delta link pour la prochaine sync incrémentale
  lastSyncAt     DateTime? // Date de la dernière synchronisation
  syncRangeStart DateTime? // Plage de sync (start)
  syncRangeEnd   DateTime? // Plage de sync (end)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique // Hash du token (jamais en clair)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime? // Date d'utilisation (pour invalider après usage)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model CompanyInvitation {
  id         String    @id @default(cuid())
  companyId  String
  email      String
  inviterId  String // Utilisateur qui envoie l'invitation
  tokenHash  String    @unique // Hash du token (jamais en clair)
  expiresAt  DateTime
  status     String    @default("PENDING") // PENDING | ACCEPTED | EXPIRED
  createdAt  DateTime  @default(now())
  acceptedAt DateTime? // Date d'acceptation

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter User    @relation("CompanyInviter", fields: [inviterId], references: [id], onDelete: Cascade)

  @@unique([companyId, email]) // Une seule invitation active par email et entreprise
  @@index([companyId])
  @@index([email])
  @@index([tokenHash])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  kind      String // action_assigned | deadline_soon | overdue | mention | comment | import_done | import_failed | export_ready | security_alert | system
  priority  String    @default("normal") // low | normal | high
  title     String
  body      String?
  targetUrl String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  dedupeKey String? // Pour éviter les doublons (ex: "deadline:actionId:date")
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([dedupeKey])
  @@index([kind])
}

model Message {
  id        String    @id @default(cuid())
  userId    String
  type      String // ai_summary | product_announcement | team_message
  subject   String
  content   String // Markdown ou texte
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
}

model ActionInvitation {
  id        String   @id @default(cuid())
  actionId  String
  inviterId String // Utilisateur qui invite
  inviteeId String // Utilisateur invité
  status    String   @default("PENDING") // PENDING | ACCEPTED | DECLINED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  action  ActionItem @relation(fields: [actionId], references: [id], onDelete: Cascade)
  inviter User       @relation("ActionInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User       @relation("ActionInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([actionId, inviteeId])
  @@index([actionId])
  @@index([inviteeId])
  @@index([status])
}

model DecisionInvitation {
  id         String   @id @default(cuid())
  decisionId String
  inviterId  String // Utilisateur qui invite
  inviteeId  String // Utilisateur invité
  status     String   @default("PENDING") // PENDING | ACCEPTED | DECLINED
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  decision Decision @relation(fields: [decisionId], references: [id], onDelete: Cascade)
  inviter  User     @relation("DecisionInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee  User     @relation("DecisionInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([decisionId, inviteeId])
  @@index([decisionId])
  @@index([inviteeId])
  @@index([status])
}

model MeetingInvitation {
  id        String   @id @default(cuid())
  meetingId String
  inviterId String // Utilisateur qui invite
  inviteeId String // Utilisateur invité
  status    String   @default("PENDING") // PENDING | ACCEPTED | DECLINED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  inviter User    @relation("MeetingInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User    @relation("MeetingInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([meetingId, inviteeId])
  @@index([meetingId])
  @@index([inviteeId])
  @@index([status])
}

// Mentions pour les actions
model ActionMention {
  id        String   @id @default(cuid())
  actionId  String
  userId    String // Utilisateur mentionné
  createdAt DateTime @default(now())

  action ActionItem @relation(fields: [actionId], references: [id], onDelete: Cascade)
  user   User       @relation("ActionMentions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([actionId, userId])
  @@index([actionId])
  @@index([userId])
}

// Mentions pour les décisions
model DecisionMention {
  id         String   @id @default(cuid())
  decisionId String
  userId     String // Utilisateur mentionné
  createdAt  DateTime @default(now())

  decision Decision @relation(fields: [decisionId], references: [id], onDelete: Cascade)
  user     User     @relation("DecisionMentions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([decisionId, userId])
  @@index([decisionId])
  @@index([userId])
}

// Mentions pour les réunions
model MeetingMention {
  id        String   @id @default(cuid())
  meetingId String
  userId    String // Utilisateur mentionné
  createdAt DateTime @default(now())

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user    User    @relation("MeetingMentions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([meetingId, userId])
  @@index([meetingId])
  @@index([userId])
}

// Commentaires pour les décisions et actions
model Comment {
  id         String   @id @default(cuid())
  decisionId String? // Optionnel : commentaire sur une décision
  actionId   String? // Optionnel : commentaire sur une action
  authorId   String // Auteur du commentaire
  content    String // Contenu du commentaire
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  decision Decision?   @relation("DecisionComments", fields: [decisionId], references: [id], onDelete: Cascade)
  action   ActionItem? @relation("ActionComments", fields: [actionId], references: [id], onDelete: Cascade)
  author   User        @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([decisionId])
  @@index([actionId])
  @@index([authorId])
  @@index([createdAt])
}

model OnboardingStep {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  stepKey     String // Clé de l'étape (ex: "create_project", "create_meeting", etc.)
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, stepKey])
  @@index([userId])
  @@index([stepKey])
}

// Suivi des vues de pages
model PageView {
  id        String   @id @default(cuid())
  userId    String? // Utilisateur connecté (null si visiteur anonyme)
  user      User?    @relation("PageViews", fields: [userId], references: [id], onDelete: SetNull)
  path      String // Chemin de la page (ex: "/app", "/app/projects", etc.)
  referer   String? // Page d'origine (referer)
  userAgent String? // User agent du navigateur
  ipAddress String? // Adresse IP (optionnel, pour statistiques anonymes)
  country   String? // Pays (détecté via IP, optionnel)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([path])
  @@index([createdAt])
  @@index([userId, path])
}
